---
title: "code_analyze_unrestrained"
author: "Hanzhi Wang"
format: html
editor: visual
---

## Import and preset

```{r}
#| echo: false
#| include: false
# load library
library(tidyverse)
library(timetk)
library(here)
library(rstatix)
library(fastDummies)
library(lme4)
library(lmerTest)
library(interactions)
```

```{r}
#| echo: false
#| include: false
# preset
theme_update(text = element_text(size = 20),
             axis.text.x = element_text(size = 20, color = "black"), axis.title.x = element_text(size = 24),
             axis.text.y = element_text(size = 20,  color = "black"), axis.title.y = element_text(size = 24), 
             panel.background = element_blank(),panel.border = element_blank(), panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(), axis.line = element_blank(), 
             legend.key = element_rect(fill = "white")) 

loc_labels <- c("Non-Sitter", "Sitter", "Crawler", "Walker","Non-Crawler")
loc_colors <- c("tomato","chartreuse4","cyan3","mediumpurple1","orange") %>% set_names(loc_labels)
age_labels <- c("Younger","Older")
age_colors <- c("red","navy") %>% set_names(age_labels)


# function
read_restrained <- function(temp_id) {
  position <- read_csv(str_glue("/Volumes/padlab/study_imu_long/data/{temp_id}/synced_data/restrained_predictions_infant.csv"),
                       show_col_types = FALSE) %>% 
    mutate(unrestrained = factor(pos, levels = c("Unrestrained","Restrained")))
  start_time <- position %>% slice_head %>% pull(time_start)
  end_time <- position %>% slice_tail %>% pull(time_start)
  position <- position %>% add_column(unique_id = temp_id, .before = 1) 
}
```

```{r}
#| echo: false
# load data (1) from local
load("whole-model-prediction.RData")
```

```{r}
#| echo: false
#| eval: false
# OR load data (2) from server
synced_ppts <- read_csv("/Volumes/padlab/study_imu_long/code/project_status/project_dashboard.csv")%>% 
  mutate(id_uni = str_glue("{id}/{session}")) %>%
  mutate(unique_id = paste0(id,"/",session)) %>%
  filter(infant_unr == 2 |infant_unr == 1) %>% #have unrestrained and/or restrained predicted
  filter(unr_exported !=0) %>% # have human annotation
  filter (id != 104) %>% #104 is pilot data
  filter(!(id == 185 & session == 2)) #185/2 leggings were put on wrong baby
# id_info has session-level basic information
id_info <- synced_ppts %>% select(unique_id, id, agemo, session, sitter, crawler, walker) %>% 
  mutate(crawler = factor(crawler, levels = c("Non-Crawler", "Crawler")),
         walker = factor(walker, levels = c("Non-Walker", "Walker")),
         sitter = factor(sitter, levels = c("Non-Sitter","Sitter"))) %>% 
  mutate(age_group = factor(as.numeric(agemo < 9), levels = c(1,0), labels = c("Younger","Older"))) %>% 
  mutate(loc = ifelse(sitter=="Non-Sitter", "Non-Sitter", 
                      ifelse(crawler == "Non-Crawler", "Sitter",
                             ifelse(walker == "Non-Walker","Crawler","Walker")))) %>% 
  mutate(age_mo = floor(agemo+0.5))
id_info[id_info$unique_id=="10/1", "crawler"] <- "Non-Crawler"
id_info[id_info$unique_id=="10/1", "loc"] <- "Sitter"

# id_demo has other demographic information
id_demo <- synced_ppts %>%
  select(unique_id, id, agemo, infant_sex, infant_ethnicity, infant_race) %>% 
  mutate(age_group = factor(as.numeric(agemo < 9), levels = c(1,0), labels = c("Younger","Older"))) %>% 
  select(-agemo) %>% 
  distinct(id, .keep_all = TRUE)
id_demo[id_demo$id=="180", "infant_sex"] <- "male"

# ds has detailed prediction for every time window
ds <- map_dfr(synced_ppts$unique_id, read_restrained)
ds <- ds %>% left_join(id_info, by = "unique_id")
  
# calculate session-level data, and excluded unavailable time chunk
ds_sum <- ds %>% group_by(unique_id, agemo, walker, crawler,sitter, age_group,loc,age_mo) %>%
  filter(exclude_period == 0, nap_period == 0) %>%
  summarize(unrestrained_n = sum(as.numeric(unrestrained == "Unrestrained")),
            total_n = n()) %>%
  mutate(unrestrained_prop = unrestrained_n/total_n) %>% 
  mutate(restrained_prop = 1-unrestrained_prop) %>% 
  ungroup()

# outliers
# 178/3, younger min, 0.15
# 148/2, younger max, 0.96
# 181/3, older min, 0.75
outliers_list_older <- 
  DescTools::Outlier(ds_sum$restrained_prop[ds_sum$age_group=="Older"], method = "boxplot")
outliers_list_younger <- 
  DescTools::Outlier(ds_sum$restrained_prop[ds_sum$age_group=="Younger"], method = "boxplot")
ds_sum_excl <- 
  ds_sum[!(ds_sum$restrained_prop %in% outliers_list_older | ds_sum$restrained_prop %in% outliers_list_younger),]


# load human coding results
ds_human <- read_csv("Restrained human coding results.csv",
                     col_select = c("Subj","Session","Restrained Prop Agree","Restrained Kappa"),
                     na=c("/")) %>%
            mutate(unique_id = paste0(Subj,"/",Session,sep="")) %>% 
            drop_na()
ds_human <- left_join(ds_sum %>% select(unique_id),
                      ds_human, by="unique_id") %>% 
            select(-c("Subj",Session))
colnames(ds_human) <- c("unique_id","agree","kappa")

# save the data frames so that don't have to download data from server again
# save(ds, ds_sum, synced_ppts, id_info, id_demo, ds_human, ds_sum_excl, file = "whole-model-prediction.RData")
```

```{r}
#| echo: false
#| eval: false
# unmatched/missing sessions--all good now
full_file_names <- dir('predict_4_pos', full.names = F)
session_loocv_have <- str_replace(unique(unlist(str_extract_all(full_file_names, "\\d+_\\d+"))), "_", "/")
session_wholemodel_have <- ds_sum$unique_id
setdiff(session_loocv_have, session_wholemodel_have)
setdiff(session_wholemodel_have, session_loocv_have)
```

```{r}
#| echo: false
# demographic statistics
count(id_demo,infant_sex)
count(id_demo,infant_ethnicity)
count(id_demo,infant_race)
count(id_demo,age_group)
```

## Human coding rel

```{r}
# human coding reliability
library(psych)
(agree<-as.data.frame(describe(ds_human$agree)))
(kappa<-as.data.frame(describe(ds_human$kappa)))
```

## Data set

```{r}
# plot dataset
dataset <- ds_sum %>% 
  mutate(subj = str_split_i(ds_sum$unique_id, "/", 1)) %>% 
  add_count(subj, name = "sess_count") %>% 
  arrange(age_mo,sess_count)

ids <- data.frame(subj = dataset$subj)
ids <- ids[!duplicated(ids), , drop = FALSE] %>% 
  mutate(temp_id = row_number())

dataset <- dataset %>% 
  left_join(ids, by = "subj")

p_data <- ggplot(data=dataset,aes(x=age_mo, y=temp_id, color=factor(loc, levels=c("Non-Sitter", "Sitter", "Crawler","Walker"))))+
  geom_line(aes(group = temp_id), color = "black") +
  geom_point(shape=16, size=5, alpha=1)+
  scale_color_manual(values=loc_colors) +
  scale_x_continuous(breaks = seq(4, 14, by = 1))+
  scale_y_continuous(breaks = c(seq(1, 66, by = 1)),
                     labels = ids$subj) +
  labs(x="Age group (months)",
       y="Subject ID",
       color = "Locomotor status")+
  theme_update()
p_data
ggsave("figure/dataset.png",p_data, width = 10, height = 18)
ggsave("figure/dataset.eps",p_data, width = 10, height = 18)
```

## Total recording time

```{r}
# total recording time
ds_sum <- ds_sum %>% 
  mutate(total_time = total_n*15/60/60)

ds_sum %>%
  summarize(time_min = min(total_time),
            time_mean = mean(total_time), 
            time_sd = sd(total_time),
            time_median = median(total_time),
            time_max = max(total_time))

t.test(data=ds_sum, total_time~age_group)

p_ttltime <- ggplot(ds_sum, aes(x=total_time))+
  geom_histogram(color = "black",)+
  labs(x = "Total recording time (h)", y = "Count")+
  scale_x_continuous(breaks = seq(0, 12, 2)) +
  scale_y_continuous(breaks = seq(0, 12, 2))
p_ttltime
ggsave("figure/total recording time dist.png",p_ttltime, width=10, height=10)
```

# Results

#Q1: Unrestrained time

```{r}
ggplot(ds_sum, aes(x = age_group, y = unrestrained_prop)) +
  geom_boxplot() + 
  geom_point(position = position_jitter(width = .1), size = 4, color = "red", shape = 1) + 
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))+
  labs(x="Age group",
       y="Unrestrained time %")
ggsave("figure/unrestrained time prop.png", width=6, height=5)

prop_un <- ds_sum %>% 
  group_by(age_group) %>% 
  summarize(min=min(unrestrained_prop),
            mean = mean(unrestrained_prop),
            sd = sd(unrestrained_prop),
            max = max(unrestrained_prop))
prop_un_excl <- ds_sum_excl %>% 
  group_by(age_group) %>% 
  summarize(min=min(unrestrained_prop),
            mean = mean(unrestrained_prop),
            sd = sd(unrestrained_prop),
            max = max(unrestrained_prop))
```

## Q2: Age-related change

```{r}
# across 4~14
# ggplot(ds_sum) +
#   geom_point(aes(x = agemo, y = unrestrained_prop)) + 
#   geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
#   scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
#   scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum))

ggplot(ds_sum_excl) +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
ggsave("figure/age_related_change.png",width=6, height=4)
ggsave("figure/age_related_change.eps",width=6, height=4)
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum_excl))

ggplot(ds_sum_excl) +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop, group=age_group), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
ggsave("figure/age_related_change_ingroup.png",width=6, height=4)
ggsave("figure/age_related_change_ingroup.eps",width=6, height=4)

```

```{r}
# within younger group comparison
ds_sum %>% 
  filter(age_group=="Younger") %>% 
  ggplot() +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum %>% filter(age_group=="Younger")))

ds_sum_excl %>% 
  filter(age_group=="Younger") %>% 
  ggplot() +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
ggsave("figure/age_related_change_young.png",width=6, height=4)
ggsave("figure/age_related_change_young.eps",width=6, height=4)
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum_excl%>% filter(age_group=="Younger")))
```

```{r}
# within older group comparison
ds_sum %>% 
  filter(age_group=="Older") %>% 
  ggplot() +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum %>% filter(age_group=="Older")))

ds_sum_excl %>% 
  filter(age_group=="Older") %>% 
  ggplot() +
  geom_point(aes(x = agemo, y = unrestrained_prop)) + 
  geom_smooth(aes(x = agemo, y = unrestrained_prop), method = "lm", se = T) + 
  scale_x_continuous(name = "Age (mos)", breaks = c(4,7,11,14), limits = c(3,15)) +
  scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))
ggsave("figure/age_related_change_old.png",width=6, height=4)
ggsave("figure/age_related_change_old.eps",width=6, height=4)
summary(lm(unrestrained_prop ~ scale(agemo), data = ds_sum_excl%>% filter(age_group=="Older")))
```

```{r}
#| eval: false
#| echo: false
# re-do lm analysis using age_base and age_change
# For now, it would be too complicated to include age_base and age_change, so skip this distinction for now.
ds_sum2 <- ds_sum
ds_sum2 <- ds_sum2 %>% 
  mutate(id = map_chr(unique_id, ~ str_split_1(.x, "/")[1])) %>% 
  group_by(id) %>% 
  mutate(age_base = first(agemo)) %>% 
  ungroup()
ds_sum2$age_change <- ds_sum2$agemo-ds_sum2$age_base

summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum2))
summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum2 %>% filter(age_group=="Younger")))
summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum2 %>% filter(age_group=="Older")))


ds_sum_excl2 <- ds_sum_excl
ds_sum_excl2 <- ds_sum_excl2 %>% 
  mutate(id = map_chr(unique_id, ~ str_split_1(.x, "/")[1])) %>% 
  group_by(id) %>% 
  mutate(age_base = first(agemo)) %>% 
  ungroup()
ds_sum_excl2$age_change <- ds_sum_excl2$agemo-ds_sum_excl2$age_base

summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum_excl2))
summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum_excl2 %>% filter(age_group=="Younger"))) # there is a significant age-base change in younger group if excluding outliers
summary(lm(unrestrained_prop ~ scale(age_base)+scale(age_change), data = ds_sum_excl2 %>% filter(age_group=="Older")))
```

## Q3-1: sitting related change
```{r}
ds_sum %>% 
  ggplot() +
    geom_point(aes(x = agemo, y = unrestrained_prop, color = sitter)) + 
    geom_smooth(aes(x = agemo, y = unrestrained_prop, color = sitter), method = "lm", se = FALSE) + 
    scale_x_continuous(name = "Age (mo)", breaks = c(4,7,11,14), limits = c(3,15)) +
    scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))+
    scale_color_manual(values=loc_colors)
ggsave("figure/sit_related_change.png", width=6, height=4)
ggsave("figure/sit_related_change.eps", width=6, height=4)
summary(lm(unrestrained_prop ~ sitter + scale(agemo), data = ds_sum))
summary(lm(unrestrained_prop ~ sitter + scale(agemo), data = ds_sum_excl))

# ds_sum %>% 
#   filter(age_group=="Younger") %>% 
#   ggplot() +
#     geom_point(aes(x = agemo, y = unrestrained_prop, color = sitter)) + 
#     geom_smooth(aes(x = agemo, y = unrestrained_prop, color = sitter), method = "lm", se = FALSE) + 
#     scale_x_continuous(name = "Age (mo)", breaks = c(4,7,11,14), limits = c(3,15)) +
#     scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))+
#     scale_color_manual(values=loc_colors)
summary(lm(unrestrained_prop ~ sitter + scale(agemo), data = ds_sum %>% filter(age_group=="Younger")))
# summary(lm(unrestrained_prop ~ sitter + scale(age_base)+scale(age_change), data = ds_sum2 %>% filter(age_group=="Younger")))

```

## Q3-2: crawling related change
```{r}
ds_sum %>% 
  ggplot() +
    geom_point(aes(x = agemo, y = unrestrained_prop, color = crawler)) + 
    geom_smooth(aes(x = agemo, y = unrestrained_prop, color = crawler), method = "lm", se = FALSE) + 
    scale_x_continuous(name = "Age (mo)", breaks = c(4,7,11,14), limits = c(3,15)) +
    scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))+
    scale_color_manual(values=loc_colors)
ggsave("figure/crawl_related_change.png", width=6, height=4)
ggsave("figure/crawl_related_change.eps", width=6, height=4)
summary(lm(unrestrained_prop ~ crawler + scale(agemo), data = ds_sum))
summary(lm(unrestrained_prop ~ crawler + scale(agemo), data = ds_sum_excl))

```

## Q3-3: crawling + sitting
```{r}
ds_sum %>% 
  mutate(loc = ifelse(loc=="Walker","Crawler",loc))%>%
  mutate(loc = factor(loc, 
                      levels = c("Non-Sitter","Sitter","Crawler"), 
                      labels=c("Non-Sitter","Sitter","Crawler")))%>% 
  ggplot() +
    geom_point(aes(x = agemo, y = unrestrained_prop, color = loc)) + 
    geom_smooth(aes(x = agemo, y = unrestrained_prop, color = loc), method = "lm", se = FALSE) + 
    scale_x_continuous(name = "Age (mo)", breaks = c(4,7,11,14), limits = c(3,15)) +
    scale_y_continuous(name = "Prop(unrestrained)", breaks = seq(0, 1, .25), limits = c(0,1))+
    scale_color_manual(values=loc_colors)
ggsave("figure/crawl_sit_change.png", width=6, height=4)
ggsave("figure/crawl_sit_change.eps", width=6, height=4)
summary(lm(unrestrained_prop ~ crawler + sitter + agemo, data = ds_sum))
summary(lm(unrestrained_prop ~ crawler + sitter + agemo, data = ds_sum_excl))
# here, excluding outliers or not influences a lot
```

## Q4: unrestrained bouts--many short bouts or few long bouts?
```{r}
# create a bout level data frame
ds_bout <- ds %>% 
  mutate(unrestrained = recode(unrestrained, "Restrained" = "r", "Unrestrained" = "u"))%>% 
  mutate(unrestrained = ifelse(nap_period==1 | exclude_period==1, "e", as.character(unrestrained)))%>% 
  mutate(bouts = with(rle(unrestrained), rep(seq_along(values), lengths)))%>%
  group_by(bouts, unrestrained,unique_id) %>%
  summarise(start_time = first(time_start),
            end_time = last(time_start),
            .groups = "drop") %>% 
  mutate(end_time = end_time+15) %>% 
  mutate(dur = as.numeric(end_time - start_time)/60/60) %>% 
  filter(unrestrained != "e")

ds_bout_sess <- ds_bout %>% 
  group_by(unique_id,unrestrained) %>% 
  summarize(n_bout = n(),
            min = min(dur),
            median = median(dur),
            max = max(dur),
            .groups="drop") %>% 
  left_join(data.frame(unique_id = ds_sum$unique_id,
                      total_time = ds_sum$total_time,
                      age_mo = ds_sum$age_mo,
                      age_group=ds_sum$age_group,
                      loc = ds_sum$loc),
             by="unique_id") %>% 
  mutate(loc=factor(loc,levels=c("Non-Sitter", "Sitter", "Crawler","Walker"))) %>% 
  mutate(bout_h = n_bout/total_time)

ds_bout_wide <- ds_bout_sess %>% 
  select(-bout_h) %>% 
  pivot_wider(names_from = unrestrained, values_from = n_bout:max) %>% 
  mutate(total_bout = n_bout_r+n_bout_u)%>% 
  mutate(loc=factor(loc,levels=c("Non-Sitter", "Sitter", "Crawler","Walker"))) %>% 
  mutate(bout_h = total_bout/total_time)

# individual bout scatter 
for(i in unique(ds_bout$unique_id)){
  ggplot(data=ds_bout %>% filter(unique_id==i), aes(x=unique_id, y=dur, color=unrestrained))+
    geom_jitter(width=.05)
  ggsave(paste0("figure_bout/",str_replace(i, "/", "_"),".png", sep=""))
}
```


## Q4-1: bout number per hour, indicating transition frequency
```{r}
# first check, bout number per hour w/ recording time
ggplot(data=ds_bout_wide, aes(x=total_time, y=bout_h))+
  geom_point()+
  geom_smooth(method="lm")+
  labs(x="total recording time (h)", y="#bout per hour")
ggsave("figure/bout_hour_uniformity.png", width=6, height=4)
summary(lm(data=ds_bout_wide, bout_h~total_time))

# bout number per hour w/ age
p_b_age<-ggplot(data=ds_bout_wide,
       aes(x=factor(age_group,levels=c("Younger","Older")),y=bout_h,color=age_group))+
  geom_jitter(width=.1)+
  stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "black")+
  scale_color_manual(values=age_colors)+
  labs(x="", y="# bouts per hour")+
  theme(legend.position = "none")

# p_b_age2<-ggplot(data=ds_bout_wide,
#        aes(x=age_mo,y=bout_h))+
#   geom_jitter(width=.1,color="black")+
#   stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "red")+
#   labs(x="", y="# bouts per hour")+
#   theme(legend.position = "none")

# bout number per hour w/ loc status
p_b_loc <- ggplot(data=ds_bout_wide, aes(x=loc,y=bout_h,color=loc))+
  geom_jitter(width=.1)+
  stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "black")+
  scale_color_manual(values=loc_colors)+
  labs(x="", y="# bouts per hour")+
  theme(legend.position = "none")

ggpubr::ggarrange(p_b_age,p_b_loc, ncol = 2, nrow = 1, widths=c(4,8), heights=c(4))
ggsave("figure/bouts_per_hour.png", width=12, height=4)
ggsave("figure/bouts_per_hour.eps", width=12, height=4)

# summary(lm(data=ds_bout_wide, bout_h~age_mo))
# summary(lm(data=ds_bout_wide %>% filter(age_group=="Younger"), bout_h~age_mo))
# summary(lm(data=ds_bout_wide %>% filter(age_group=="Older"), bout_h~age_mo))
summary(lm(data=ds_bout_wide, bout_h~age_group))
summary(anova_result <- aov(data=ds_bout_wide, bout_h~loc))
TukeyHSD(anova_result)
# summary(lm(data=ds_bout_wide, bout_h~age_mo+loc))
# summary(lm(data=ds_bout_wide, bout_h~age_group+loc))
```

## Q4-2: bout median duration
```{r}
# bout number per hour w/ age
ds_bout_wide <- ds_bout_wide %>% 
  mutate(median = median_r+median_u)

p_bm_age1<-ggplot(data=ds_bout_wide,
       aes(x=factor(age_group,levels=c("Younger","Older")),y=median_r+median_u,color=age_group))+
  geom_jitter(width=.1)+
  stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "black")+
  scale_color_manual(values=age_colors)+
  labs(x="", y="Median Duration of Bouts (h)")+
  theme(legend.position = "none")


p_bm_loc1 <- ggplot(data=ds_bout_wide, aes(x=loc,y=median_r+median_u,color=loc))+
  geom_jitter(width=.1)+
  stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "black")+
  scale_color_manual(values=loc_colors)+
  labs(x="", y="Median Duration of Bouts (h)")+
  theme(legend.position = "none")

ggpubr::ggarrange(p_bm_age1,p_bm_loc1, ncol = 2, nrow = 1, widths=c(4,8), heights=c(4))
ggsave("figure/bouts_median.png", width=12, height=4)
ggsave("figure/bouts_median.eps", width=12, height=4)

summary(lm(data=ds_bout_wide, median~age_group))
summary(anova_result2 <- aov(data=ds_bout_wide, median~loc))
TukeyHSD(anova_result2)
```

## Q4-3: bout median dur unrestrained comp. restrained 
```{r}
# bout median w/ age
p_bm_age<-ds_bout_sess %>%
  mutate(ag_num=as.numeric(age_group),
         x_shift = case_when(
           unrestrained == "r" ~ ag_num - 0.3,
           unrestrained == "u" ~ ag_num + 0.3)) %>% 
  ggplot(aes(x=x_shift, y=median, color=age_group, shape = unrestrained))+
    geom_point(size=3)+
    geom_line(aes(group = unique_id), color = "black", alpha=.05)+
    # stat_summary(fun = mean, geom = "crossbar", width = 0.3, color = "black")+
    labs(x="", y ="Median Duration of Bouts (h)")+
    scale_x_continuous(breaks = c(1,2), 
                       labels = c("Younger","Older"))+
    scale_y_continuous(breaks=seq(0,0.6,0.1))+
    scale_color_manual(values=age_colors)+
    scale_shape_manual(values = c("r" = 1, "u" = 16))+
    theme(legend.position = "none")

t.test (x=ds_bout_sess$median[ds_bout_sess$unrestrained=="r"], 
        y=ds_bout_sess$median[ds_bout_sess$unrestrained=="u"], 
        paired=TRUE) # across groups, non-significant

t.test (x=ds_bout_sess$median[ds_bout_sess$unrestrained=="r" & ds_bout_sess$age_group=="Younger"], 
        y=ds_bout_sess$median[ds_bout_sess$unrestrained=="u" & ds_bout_sess$age_group=="Younger"],
        paired=TRUE) # Younger group, not significant 

t.test (x=ds_bout_sess$median[ds_bout_sess$unrestrained=="r" & ds_bout_sess$age_group=="Older"], 
        y=ds_bout_sess$median[ds_bout_sess$unrestrained=="u" & ds_bout_sess$age_group=="Older"],
        paired=TRUE) # Older group, median duration of unrestrained time is significantly higher


# bout median w/ loc status
p_bm_loc<-ds_bout_sess %>%
  mutate(loc_num=as.numeric(loc),
         x_shift = case_when(
           unrestrained == "r" ~ loc_num - 0.15,
           unrestrained == "u" ~ loc_num + 0.15)) %>% 
  ggplot(aes(x=x_shift, y=median, color=loc, shape = unrestrained))+
    geom_point(size=3)+
    # geom_jitter(width=.1)+
    geom_line(aes(group = unique_id), color = "black", alpha=.05)+
    scale_shape_manual(values = c("r" = 1, "u" = 16)) +
    scale_color_manual(values=loc_colors)+
    scale_x_continuous(breaks = c(1,2,3,4), 
                       labels = c("Non-Sitter","Sitter","Crawler","Walker"))+
    labs(x="", y="Median Duration of Bouts (h)")

ggpubr::ggarrange(p_bm_age,p_bm_loc, ncol = 2, nrow = 1, widths=c(4,8), heights=c(4))
ggsave("figure/bouts_median_comp.png", width=12, height=4)
ggsave("figure/bouts_median_comp.eps", width=12, height=4)

# t.test(data=ds_bout_sess %>% filter(loc=="Non-Sitter"), median~unrestrained)
# t.test(data=ds_bout_sess %>% filter(loc=="Sitter"), median~unrestrained)
# t.test(data=ds_bout_sess %>% filter(loc=="Crawler"), median~unrestrained) # significant
# t.test(data=ds_bout_sess %>% filter(loc=="Walker"), median~unrestrained) # significant
# summary(aov(data=ds_bout_sess %>% filter(unrestrained=="r"), median~loc))
# summary(aov(data=ds_bout_sess %>% filter(unrestrained=="u"), median~loc))
# summary(aov(data=ds_bout_sess, median~loc*unrestrained))

for (l in loc_labels[1:4]){
  temp<- ds_bout_sess %>% filter(loc==l)
  print(l)
  print(t.test (x=temp$median[temp$unrestrained=="r"], 
          y=temp$median[temp$unrestrained=="u"], 
          paired=TRUE))
}

```

## Q5: dominant positions when unrestrained
```{r}
# need 30s-bin position data


```

